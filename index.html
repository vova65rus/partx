<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --success-color: #28a745;
      --error-color: #dc3545;
      --border-radius: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f5;
      margin: 0;
      padding: 16px;
      line-height: 1.5;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .user-info {
      margin-bottom: 16px;
      font-size: 14px;
      color: #495057;
      text-align: center;
    }

    h2 {
      text-align: center;
      margin: 16px 0;
      color: #212529;
    }

    .filters {
      background: #fff;
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filters input,
    .filters select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    .filters label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border: none;
      border-radius: 4px;
      background: var(--primary-color);
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #0056b3;
    }

    button.secondary {
      background: #6c757d;
    }

    .results {
      margin-top: 16px;
    }

    .card {
      background: #fff;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card.premium {
      border-left: 4px solid #ffd700;
    }

    .seller-panel {
      margin-top: 24px;
      background: #fff;
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .status-message {
      margin-top: 12px;
      font-size: 14px;
      text-align: center;
    }

    .status-message.success {
      color: var(--success-color);
    }

    .status-message.error {
      color: var(--error-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="user-info" id="userInfo"></div>
    <button class="secondary" onclick="showMyOrders()">üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>

    <h2>üîß –ü–æ–∏—Å–∫ –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π</h2>
    <div class="filters">
      <input type="text" id="searchInput" placeholder="–ù–æ–º–µ—Ä –¥–µ—Ç–∞–ª–∏, –∫—É–∑–æ–≤ –∏–ª–∏ –∞–≤—Ç–æ" />
      <select id="citySelect">
        <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
        <option value="–Æ–∂–Ω–æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫">–Æ–∂–Ω–æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫</option>
        <option value="–•–æ–ª–º—Å–∫">–•–æ–ª–º—Å–∫</option>
        <option value="–ö–æ—Ä—Å–∞–∫–æ–≤">–ö–æ—Ä—Å–∞–∫–æ–≤</option>
      </select>
      <label>
        <input type="checkbox" id="inStockOnly" /> –¢–æ–ª—å–∫–æ –≤ –Ω–∞–ª–∏—á–∏–∏
      </label>
      <select id="sortSelect">
        <option value="">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
        <option value="price_asc">–ü–æ —Ü–µ–Ω–µ ‚Üë</option>
        <option value="price_desc">–ü–æ —Ü–µ–Ω–µ ‚Üì</option>
      </select>
      <button onclick="searchParts()">üîç –ù–∞–π—Ç–∏</button>
    </div>

    <div class="results" id="results"></div>

    <div class="seller-panel" id="sellerPanel" style="display: none;">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</h3>
      <input type="text" id="partName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏" />
      <input type="text" id="partModel" placeholder="–ê–≤—Ç–æ / –∫—É–∑–æ–≤" />
      <input type="text" id="partCode" placeholder="–ü–∞—Ä—Ç –Ω–æ–º–µ—Ä" />
      <input type="text" id="partPrice" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" pattern="[0-9]*" />
      <input type="text" id="partCity" placeholder="–ì–æ—Ä–æ–¥" />
      <label>
        <input type="checkbox" id="partInStock" /> –í –Ω–∞–ª–∏—á–∏–∏
      </label>
      <label>
        <input type="checkbox" id="partPremium" /> –ü—Ä–µ–º–∏—É–º –º–∞–≥–∞–∑–∏–Ω
      </label>
      <button onclick="submitPart()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div class="status-message" id="submitStatus"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const SELLERS = [123456789, 987654321]; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ Telegram ID
    const API_URL = 'https://script.google.com/macros/s/AKfycbyqw5aC0TcWabXBncQ5_tBwWC_DlOinJPwSW1eauqRsUs_iLbmXV2qRPoVg4UXESrT-/exec'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function initUser() {
      const user = tg.initDataUnsafe?.user;
      const userInfo = document.getElementById('userInfo');
      
      if (!user) {
        userInfo.innerHTML = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        return;
      }

      userInfo.innerHTML = `üë§ ${sanitizeHTML(user.first_name)} (@${sanitizeHTML(user.username || '–Ω–µ—Ç username')})<br>ID: ${user.id}`;
      if (SELLERS.includes(user.id)) {
        document.getElementById('sellerPanel').style.display = 'block';
      }

      return user;
    }

    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS
    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
    function showMyOrders() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="card">üìã –í–∞—à–∏ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</div>';
    }

    // –ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π
    async function searchParts() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="card">‚è≥ –ò—â–µ–º...</div>';

      try {
        const query = document.getElementById('searchInput').value.trim();
        const city = document.getElementById('citySelect').value;
        const inStockOnly = document.getElementById('inStockOnly').checked;
        const sort = document.getElementById('sortSelect').value;

        const url = new URL(API_URL);
        url.searchParams.append('query', query);

        const response = await fetch(url);
        if (!response.ok) throw new Error('Network error');
        
        let results = await response.json();

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        if (city) {
          results = results.filter(part => part.city === city);
        }
        if (inStockOnly) {
          results = results.filter(part => part.availability.toLowerCase().includes('–≤ –Ω–∞–ª–∏—á–∏–∏'));
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        if (sort === 'price_asc') {
          results.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
        } else if (sort === 'price_desc') {
          results.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
        }

        resultsDiv.innerHTML = '';
        if (!results?.length) {
          resultsDiv.innerHTML = '<div class="card">üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
          return;
        }

        results.forEach(part => {
          const card = document.createElement('div');
          card.className = `card ${part.premium ? 'premium' : ''}`;
          card.innerHTML = `
            <strong>üì¶ ${sanitizeHTML(part.name)} (${sanitizeHTML(part.part)})</strong><br>
            üöó ${sanitizeHTML(part.model)}<br>
            üí∞ ${sanitizeHTML(part.price)}‚ÇΩ ‚Äî ${sanitizeHTML(part.availability)}<br>
            üè¨ ${sanitizeHTML(part.store)} ‚Äî ${sanitizeHTML(part.city)}<br>
          `;
          resultsDiv.appendChild(card);
        });
      } catch (error) {
        resultsDiv.innerHTML = '<div class="card">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
        console.error('Search error:', error);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∑–∞–ø—á–∞—Å—Ç–∏
    async function submitPart() {
      const statusDiv = document.getElementById('submitStatus');
      const user = tg.initDataUnsafe?.user;

      const partData = {
        name: document.getElementById('partName').value.trim(),
        model: document.getElementById('partModel').value.trim(),
        part: document.getElementById('partCode').value.trim(),
        price: document.getElementById('partPrice').value.trim(),
        city: document.getElementById('partCity').value.trim(),
        availability: document.getElementById('partInStock').checked ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ü–æ–¥ –∑–∞–∫–∞–∑',
        premium: document.getElementById('partPremium').checked,
        store: user?.username || user?.first_name || '–ê–Ω–æ–Ω–∏–º',
        user_id: user?.id || null
      };

      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!partData.name || !partData.model || !partData.price || !partData.city) {
        statusDiv.className = 'status-message error';
        statusDiv.innerText = '‚ùó –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
        return;
      }

      if (isNaN(parseFloat(partData.price))) {
        statusDiv.className = 'status-message error';
        statusDiv.innerText = '‚ùó –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º';
        return;
      }

      statusDiv.className = 'status-message';
      statusDiv.innerText = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(partData)
        });

        if (!response.ok) throw new Error('Network error');
        
        statusDiv.className = 'status-message success';
        statusDiv.innerText = '‚úÖ –ó–∞–ø—á–∞—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞';
        
        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.querySelectorAll('.seller-panel input:not([type=checkbox])').forEach(input => input.value = '');
        document.querySelectorAll('.seller-panel input[type=checkbox]').forEach(input => input.checked = false);
      } catch (error) {
        statusDiv.className = 'status-message error';
        statusDiv.innerText = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏';
        console.error('Submit error:', error);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', initUser);
  </script>
</body>
</html>
