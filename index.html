<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: auto;
      text-align: center;
    }
    .filters input,
    .filters select {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      font-size: 14px;
    }
    .filters label {
      display: block;
      margin-top: 8px;
      text-align: left;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
    }
    #results {
      margin-top: 20px;
      text-align: left;
    }
    .card {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    }
    .card.premium {
      border-left: 5px solid gold;
    }
    input[type="text"] {
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="userInfo" style="margin-bottom: 16px; font-size: 14px; color: #555;"></div>
    <button onclick="showMyOrders()" style="background:#eaeaea;">üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>

    <h2>üîß –ü–æ–∏—Å–∫ –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π</h2>

    <div class="filters">
      <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ—Ç–∞–ª–∏, –∫—É–∑–æ–≤ –∏–ª–∏ –∞–≤—Ç–æ" />

      <select id="citySelect">
        <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
        <option value="–Æ–∂–Ω–æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫">–Æ–∂–Ω–æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫</option>
        <option value="–•–æ–ª–º—Å–∫">–•–æ–ª–º—Å–∫</option>
        <option value="–ö–æ—Ä—Å–∞–∫–æ–≤">–ö–æ—Ä—Å–∞–∫–æ–≤</option>
      </select>

      <label><input type="checkbox" id="inStockOnly" /> –¢–æ–ª—å–∫–æ –≤ –Ω–∞–ª–∏—á–∏–∏</label>

      <select id="sortSelect">
        <option value="">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
        <option value="price_asc">–ü–æ —Ü–µ–Ω–µ ‚Üë</option>
        <option value="price_desc">–ü–æ —Ü–µ–Ω–µ ‚Üì</option>
      </select>

      <button onclick="searchParts()">üîç –ù–∞–π—Ç–∏</button>
    </div>

    <div id="results"></div>

    <div id="sellerPanel" style="margin-top: 30px; display: none;">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</h3>
      <input type="text" id="partName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏" />
      <input type="text" id="partModel" placeholder="–ê–≤—Ç–æ / –∫—É–∑–æ–≤" />
      <input type="text" id="partCode" placeholder="–ü–∞—Ä—Ç –Ω–æ–º–µ—Ä" />
      <input type="text" id="partPrice" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" />
      <input type="text" id="partCity" placeholder="–ì–æ—Ä–æ–¥" />
      <label><input type="checkbox" id="partInStock" /> –í –Ω–∞–ª–∏—á–∏–∏</label>
      <label><input type="checkbox" id="partPremium" /> –ü—Ä–µ–º–∏—É–º –º–∞–≥–∞–∑–∏–Ω</label>
      <button onclick="submitPart()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="submitStatus" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe.user;
    const SELLERS = [123456789, 987654321]; // üîÅ –ó–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ Telegram ID –ø—Ä–æ–¥–∞–≤—Ü–æ–≤

    if (user) {
      document.getElementById('userInfo').innerHTML = `üë§ ${user.first_name} (@${user.username || '–Ω–µ—Ç username'})<br>ID: ${user.id}`;
      if (SELLERS.includes(user.id)) {
        document.getElementById('sellerPanel').style.display = 'block';
      }
    } else {
      document.getElementById('userInfo').innerHTML = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
    }

    function showMyOrders() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="card">üìã –í–∞—à–∏ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</div>`;
    }

    function searchParts() {
      const query = document.getElementById('searchInput').value.trim();
      const city = document.getElementById('citySelect').value;
      const inStockOnly = document.getElementById('inStockOnly').checked;
      const sort = document.getElementById('sortSelect').value;
      const resultsDiv = document.getElementById('results');

      resultsDiv.innerHTML = '‚è≥ –ò—â–µ–º...';

      // –ó–∞–ø—Ä–æ—Å –∫ Google Apps Script (GET)
      const url = `https://script.google.com/macros/s/AKfycbx7QSF4r_yD4PVRKjwtJg6f8oK3DUXFJXMTTPwcKpQ-DZP0XfTEB8KrsJLMQ9ZL0BHS/exec?query=${encodeURIComponent(query)}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          let results = data;

          if (city) results = results.filter(part => part.city === city);
          if (inStockOnly) results = results.filter(part => part.availability.toLowerCase().includes('–≤ –Ω–∞–ª–∏—á–∏–∏'));

          if (sort === 'price_asc') results.sort((a, b) => parseInt(a.price) - parseInt(b.price));
          else if (sort === 'price_desc') results.sort((a, b) => parseInt(b.price) - parseInt(a.price));

          resultsDiv.innerHTML = '';
          if (!results || results.length === 0) {
            resultsDiv.innerHTML = 'üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            return;
          }

          results.forEach(part => {
            const card = document.createElement('div');
            card.className = 'card' + (part.premium ? ' premium' : '');
            card.innerHTML = `
              <strong>üì¶ ${part.name} (${part.part})</strong><br>
              üöó ${part.model}<br>
              üí∞ ${part.price}‚ÇΩ ‚Äî ${part.availability}<br>
              üè¨ ${part.store} ‚Äî ${part.city}<br>
            `;
            resultsDiv.appendChild(card);
          });
        })
        .catch(err => {
          resultsDiv.innerHTML = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
          console.error(err);
        });
    }

    function submitPart() {
      const name = document.getElementById('partName').value.trim();
      const model = document.getElementById('partModel').value.trim();
      const part = document.getElementById('partCode').value.trim();
      const price = document.getElementById('partPrice').value.trim();
      const city = document.getElementById('partCity').value.trim();
      const availability = document.getElementById('partInStock').checked ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ü–æ–¥ –∑–∞–∫–∞–∑';
      const premium = document.getElementById('partPremium').checked;

      if (!name || !model || !price || !city) {
        document.getElementById('submitStatus').innerText = '‚ùó –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
      }

      const payload = {
        name, model, part, price, city,
        availability, premium,
        store: user.username || user.first_name,
        user_id: user.id
      };

      document.getElementById('submitStatus').innerText = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

      fetch("https://script.google.com/macros/s/AKfycbx7QSF4r_yD4PVRKjwtJg6f8oK3DUXFJXMTTPwcKpQ-DZP0XfTEB8KrsJLMQ9ZL0BHS/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(() => {
        document.getElementById('submitStatus').innerText = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
      }).catch(() => {
        document.getElementById('submitStatus').innerText = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
      });
    }
  </script>
</body>
</html>
